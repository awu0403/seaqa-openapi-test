# This GitHub Actions workflow syncs docs and OpenAPI definitions to ReadMe
# Documentation: https://docs.readme.com/main/docs/rdme
name: ReadMe GitHub Action ğŸ¦‰

on:
  push:
    branches:
      # This workflow will run every time you push code to the following branch
      # Check out GitHub's docs for more info on configuring this:
      # https://docs.github.com/actions/using-workflows/events-that-trigger-workflows
      - master

jobs:
  rdme-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo ğŸ“š
        uses: actions/checkout@v4

      - name: è¯Šæ–­æ–‡ä»¶ä¸ç½‘ç»œ
        run: |
          echo "1. æ£€æŸ¥referenceç›®å½•ç»“æ„ï¼š"
          ls -la ./reference/
          echo "2. æ£€æŸ¥å…·ä½“Markdownæ–‡ä»¶å†…å®¹ï¼ˆå‰10è¡Œï¼‰ï¼š"
          head -10 ./reference/errors.md ./reference/introduction.md
          echo "3. æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼ˆå¦‚ReadMe APIï¼‰ï¼š"
          curl -I https://dash.readme.com
          echo "4. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦è®¾ç½®ï¼š"
          if [ -z "${{ secrets.README_API_KEY }}" ]; then
            echo "ERROR: README_API_KEY not set"
            exit 1
          else
            echo "README_API_KEY is set"
          fi
          echo "=== 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ ==="
          ls -la ./reference/errors.md ./reference/introduction.md

          echo "=== 2. æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼ˆç¤ºä¾‹ï¼‰==="
          head -20 ./reference/errors.md
          echo "---"
          head -20 ./reference/introduction.md

          echo "=== 3. æ£€æŸ¥æ¢è¡Œç¬¦ï¼ˆ^Mè¡¨ç¤ºCRLFï¼‰==="
          cat -A ./reference/errors.md | head -5

          echo "=== 4. æ£€æŸ¥æ–‡ä»¶ç¼–ç ï¼ˆå‰3å­—èŠ‚ï¼‰==="
          head -c3 ./reference/errors.md | od -An -tx1
          
      # Seaqa API (docs only)
      - name: Update Seaqa API ğŸš€
        uses: readmeio/rdme@v10
        with:
          rdme: docs upload ./reference --key=${{ secrets.README_API_KEY }} --branch=1.0

      # ticket operations: user
      - name: Ticket operations ğŸš€
        uses: readmeio/rdme@v10
        with:
          rdme: openapi upload ./api/ticket_operations.yaml --key=${{ secrets.README_API_KEY }} --slug=ticket_operations
